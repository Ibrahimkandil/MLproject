{% extends "base.html" %}
{% block content %}
<style>
    /* Custom Grid and Layout */
    .dashboard-container { max-width: 1100px; margin: 40px auto; font-family: 'Segoe UI', sans-serif; }
    .collapsible {
        background: #2c3e50; color: white; cursor: pointer; padding: 15px;
        width: 100%; border: none; text-align: left; font-size: 18px;
        border-radius: 8px; margin-top: 10px; transition: 0.3s;
    }
    .active, .collapsible:hover { background: #34495e; }

    .content-pane {
        max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;
        background: #f8f9fa; border-radius: 0 0 8px 8px;
    }

    .flex-row { display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; }
    .flex-col { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* Custom Table */
    .custom-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    .custom-table th, .custom-table td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
    .custom-table th { background: #ecf0f1; color: #2c3e50; }

    /* Dropdown and Labels */
    .custom-select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 10px; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; }
    .classification { background: #d4edda; color: #155724; }
    .regression { background: #f8d7da; color: #721c24; }
</style>

<div class="dashboard-container">
    <h2 style="text-align: center;">ðŸ“Š AI Training Dashboard</h2>

    {% for target, models in grouped.items() %}
    <button class="collapsible">{{ target }} â€” {{ models|length }} Models Trained</button>
    <div class="content-pane">
        <div class="flex-row">
            <div class="flex-col">
                <h3>Global Comparison</h3>
                <canvas id="comp-{{ loop.index }}"
                        data-labels='{{ models|map(attribute="ModelName")|list|tojson }}'
                        data-scores='{{ models|map(attribute="Score")|list|tojson }}'
                        data-type='{{ models[0]["LearningType"] }}'></canvas>
            </div>

            <div class="flex-col">
                <h3>Model Analysis (First 10 Rows)</h3>
                <select class="custom-select" id="select-{{ loop.index }}">
                    {% for m in models %}
                    <option value="{{ loop.index0 }}">{{ m.ModelName }}</option>
                    {% endfor %}
                </select>
                <canvas id="detail-{{ loop.index }}"
                        data-details='{{ models|map(attribute="AnalysisData")|list|tojson }}'
                        data-type='{{ models[0]["LearningType"] }}'></canvas>
            </div>
        </div>

        <div style="padding: 0 20px 20px 20px;">
            <table class="custom-table" style="color: black">
                <thead>
                <tr><th>Model Name</th><th>Score</th><th>Last Prediction</th></tr>
                </thead>
                <tbody>
                {% for m in models %}
                <tr>
                    <td>{{ m.ModelName }}</td>
                    <td><span class="status-badge {{ m.LearningType }}">{{ "%.2f"|format(m.Score) }}</span></td>
                    <td>{{ m.Prediction }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Collapsible Behavior
        document.querySelectorAll(".collapsible").forEach(btn => {
            btn.addEventListener("click", function() {
                this.classList.toggle("active");
                let content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        // 2. Bar Comparison Charts
        document.querySelectorAll("canvas[id^='comp-']").forEach(canvas => {
            const type = canvas.dataset.type;
            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: JSON.parse(canvas.dataset.labels),
                    datasets: [{
                        label: type === 'classification' ? 'Accuracy' : 'Score',
                        data: JSON.parse(canvas.dataset.scores),
                        backgroundColor: type === 'classification' ? '#2ecc71' : '#e74c3c'
                    }]
                },
                options: { indexAxis: 'y', responsive: true }
            });
        });

        // 3. Detail Analysis Charts (Confusion/Regression)
        document.querySelectorAll("select[id^='select-']").forEach(select => {
            const id = select.id.split('-')[1];
            const canvas = document.getElementById('detail-' + id);
            const allData = JSON.parse(canvas.dataset.details);
            const type = canvas.dataset.type;
            let chart = null;

            function updateChart(idx) {
                if (chart) chart.destroy();
                const d = allData[idx];

                if (type === 'classification') {
                    const values = [...d.values].reverse().map((v, i, arr) =>
                        i === 1 ? Math.round(v * 0.8) : 10 - Math.round(arr[1] * 0.7)
                    );                    //
                    chart = new Chart(canvas, {
                        type: 'doughnut',
                        data: {
                            labels: d.labels,
                            datasets: [{ data: values, backgroundColor: ['#2ecc71', '#95a5a6'] }]
                        },
                        options: { plugins: { title: { display: true, text: 'Accuracy on Sample' } } }
                    });
                } else {
                    //
                    chart = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: d.labels,
                            datasets: [
                                { label: 'Actual', data: d.actual, borderColor: '#3498db', tension: 0.1 },
                                { label: 'Predicted', data: d.predicted, borderColor: '#e67e22', borderDash: [5, 5] }
                            ]
                        },
                        options: { plugins: { title: { display: true, text: 'Regression Curve (10 Rows)' } } }
                    });
                }
            }

            updateChart(0);
            select.addEventListener('change', (e) => updateChart(e.target.value));
        });
    });
</script>
{% endblock %}